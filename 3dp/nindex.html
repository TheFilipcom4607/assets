<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Print Price Calculator</title>
  <style>
    body{max-width:800px;margin:2em auto;padding:1em;color:#eaeaea;font:15px/1.4 -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#121212}
    label{margin-top:.6em;display:block}
    input,select,button,textarea{width:100%;margin-bottom:.6em;font:inherit}
    textarea{resize:vertical}
    input,select,textarea{background:#232323;border:1px solid #444;border-radius:5px;padding:8px;color:#eaeaea}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
    input:focus,select:focus,textarea:focus{outline:2px solid #40E0D0;border-color:#40E0D0;background:#181818}
    button{background:#232323;color:#eaeaea;border:1px solid #40E0D0;border-radius:5px;padding:10px 20px;cursor:pointer;transition:all .2s;width:auto;margin-right:1em}
    button:hover{background:#181818;color:#40E0D0}
    .flex{display:flex;gap:.6em;align-items:center}
    details summary{cursor:pointer;margin-top:.4em}
    .box{background:#232323;border:1px solid #333;border-radius:6px;padding:1em;margin-top:1.2em}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:4px 6px}
    .break-even{color:#40e0a0;font-weight:bold}
    .profit{color:#60aaff;font-weight:bold}
    .loss{color:#ff5e5e;font-weight:bold}
    footer{text-align:center;margin-top:2em;color:#888;font-size:.9em}
    .footer-heart{color:#ff4e4e;animation:softPulse 2s infinite}
    @keyframes softPulse{0%{opacity:0.7}50%{opacity:1}100%{opacity:0.7}}
    a{color:#40E0D0;text-decoration:none}
    a:hover{text-decoration:underline}
    #partsList{margin-top:1.5em;padding:0}
    .part-item{background:#232323;border:1px solid #333;border-radius:6px;padding:1em;margin-bottom:1em;position:relative}
    .remove-part{position:absolute;top:8px;right:8px;width:24px;height:24px;line-height:20px;text-align:center;background:#333;color:#eee;border-radius:50%;cursor:pointer;font-size:16px;border:none}
    .remove-part:hover{background:#444}
    .part-header{display:flex;justify-content:space-between;margin-bottom:8px}
    .part-name{font-weight:bold;font-size:1.1em}
    #totalQuote{margin-top:1.5em;font-weight:bold;font-size:1.1em;padding:0.6em;background:#232323;border:1px solid #333;border-radius:6px;text-align:right}
    .tabs{display:flex;border-bottom:1px solid #444;margin-bottom:1em}
    .tab{padding:8px 16px;cursor:pointer;background:#232323;border:1px solid #444;border-bottom:none;border-radius:5px 5px 0 0;margin-right:4px}
    .tab.active{background:#181818;border-bottom-color:#181818;color:#40E0D0}
    .tab-content{display:none}
    .tab-content.active{display:block}
    #shipOrderWide{margin-top:1em}
  </style>
</head>
<body>
  <h2>3D Print Price Calculator</h2>
  <div class="tabs">
    <div class="tab active" data-tab="part-settings">Part Settings</div>
    <div class="tab" data-tab="quote-list">Quote List</div>
    <div class="tab" data-tab="notes">Notes</div>
  </div>

  <div id="part-settings" class="tab-content active">
    <!-- BASIC INFO -->
    <label for="itemName">Product / Model Name:</label>
    <input id="itemName" placeholder="Phone holder">

    <div class="flex">
      <label for="currency" style="width:auto">Currency:</label>
      <select id="currency" style="width:auto">
        <option value="zł">zł</option>
        <option value="€">€</option>
        <option value="$">$</option>
        <option value="£">£</option>
      </select>
    </div>

    <label for="printerPreset">Printer:</label>
    <select id="printerPreset">
      <option value="">— select —</option>
      <option value="p1p">Bambu P1P</option>
    </select>

    <label for="weight">Model Weight (g each):</label>
    <input id="weight" type="number" placeholder="42">
    <label for="batch">Quantity (batch size):</label>
    <input id="batch" type="number" placeholder="3">
    <label for="hours">Print Time (h total):</label>
    <input id="hours" type="number" placeholder="9">

    <label for="filamentPrice">Filament Price (per kg):</label>
    <input id="filamentPrice" type="number" placeholder="129">
    <label for="electricityPrice">Electricity (per kWh):</label>
    <input id="electricityPrice" type="number" placeholder="0.90">
    <label for="power">Power Draw (W):</label>
    <input id="power" type="number" placeholder="100">
    <label for="maintenance">Maintenance (per h):</label>
    <input id="maintenance" type="number" placeholder="0.75">
    <label for="handling">Handling (per batch):</label>
    <input id="handling" type="number" placeholder="6">

    <div class="flex">
      <input id="vat" type="checkbox">
      <label for="vat" style="width:auto">Add VAT 23%</label>
    </div>

    <details>
      <summary>Extras & Margins</summary>
      <label for="profit30">Margin 1 %:</label>
      <input id="profit30" type="number" placeholder="30">
      <label for="profit50">Margin 2 %:</label>
      <input id="profit50" type="number" placeholder="50">
      <label for="profit100">Margin 3 %:</label>
      <input id="profit100" type="number" placeholder="100">

      <label for="priceTier">Price to Quote:</label>
      <select id="priceTier">
        <option value="1">Use Margin 1</option>
        <option value="2">Use Margin 2</option>
        <option value="3">Use Margin 3</option>
      </select>

      <label for="competitor">Competitor Price:</label>
      <input id="competitor" type="number" placeholder="50">

      <hr style="border-color:#444;margin:1em 0">
      <label for="postProcessPiece">Post-process (per piece):</label>
      <input id="postProcessPiece" type="number" placeholder="2">
      <label for="packageBatch">Packaging (per batch):</label>
      <input id="packageBatch" type="number" placeholder="5">
    </details>

    <button onclick="calculate()">Calculate</button>
    <button onclick="addToQuote()">Add to Quote</button>
    <button id="shareBtn" onclick="generateShareLink()">Generate Shareable Link</button>
    <input id="shareUrl" type="text" readonly placeholder="Shareable URL" style="display:none">

    <div id="result"></div>
  </div>

  <div id="quote-list" class="tab-content">
    <h3>Parts List</h3>
    <div id="partsList"><p>No parts added yet. Use Calculate then Add to Quote.</p></div>

    <div class="box" id="shipOrderWide">
      <div class="flex">
        <div style="flex:1">
          <label for="shippingOrder">Shipping Cost:</label>
          <input id="shippingOrder" type="number" placeholder="10">
        </div>
        <div style="flex:1">
          <label for="shippingMethod">Shipping Method:</label>
          <select id="shippingMethod">
            <option value="">— select or type —</option>
            <option value="DHL">DHL</option>
            <option value="Pocztex">Pocztex</option>
            <option value="FedEx">FedEx</option>
            <option value="Local Pickup">Local Pickup</option>
          </select>
        </div>
      </div>
      <p id="totalQuote">Total Quote: 0.00</p>
    </div>

    <button onclick="printMultiPartQuote()">Generate Quote</button>
    <button onclick="clearParts()">Clear All Parts</button>
  </div>

  <div id="notes" class="tab-content">
    <h3>Additional Notes</h3>
    <label for="customerInfo">Customer Information:</label>
    <textarea id="customerInfo" rows="3" placeholder="Customer name, contact info..."></textarea>
    <label for="paymentTerms">Payment Terms:</label>
    <textarea id="paymentTerms" rows="2" placeholder="Payment due within 14 days"></textarea>
    <label for="additionalNotes">Additional Notes:</label>
    <textarea id="additionalNotes" rows="5" placeholder="Any special instructions..."></textarea>
  </div>

  <footer>made with <span class="footer-heart">❤️</span> by <a href="https://thefilip.com" target="_blank">thefilip</a></footer>

  <script>
    const presets = { p1p:{ power:100, maintenance:0.75, handling:6 } };
    printerPreset.onchange = e => {
      const p = presets[e.target.value] || {};
      power.value = p.power || '';
      maintenance.value = p.maintenance || '';
      handling.value = p.handling || '';
    };

    const n=id=>parseFloat(document.getElementById(id).value||0);
    const cur=()=>currency.value;
    let currentCalc=null, parts=[];

    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        updateTotalQuote();
      });
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      // editable shippingMethod
      const sm = document.getElementById('shippingMethod');
      sm.addEventListener('change', ()=>{
        if(!sm.value){
          setTimeout(()=>{
            const nm = prompt('Enter custom shipping method:','');
            if(nm){ const o=document.createElement('option'); o.value=o.text=nm; sm.add(o); sm.value=nm; }
          },100);
        }
      });
      // parse shareable link params
      const params=new URLSearchParams(location.search);
      params.forEach((v,k)=>{
        const el=document.getElementById(k);
        if(!el) return;
        if(el.type==='checkbox') el.checked=(v==='true'); else el.value=v;
      });
      if([...params.keys()].length>0) calculate();
    });

    function calculate(){
      const name=itemName.value||'3D Print', w=n('weight'), b=Math.max(n('batch')||1,1), h=n('hours');
      const fk=n('filamentPrice'), ep=n('electricityPrice'), pw=n('power');
      const mh=n('maintenance'), hb=n('handling');
      const vat=document.getElementById('vat').checked, VAT=0.23;
      const pp=n('postProcessPiece'), pkg=n('packageBatch');
      const m1=n('profit30')||30, m2=n('profit50')||50, m3=n('profit100')||100;
      const tier=parseInt(priceTier.value,10);
      const mat=fk*((w/1000)*b), ele=(pw*h/1000)*ep, mnt=mh*h;
      const extras=pkg+(pp*b), batchTotal=mat+ele+mnt+hb+extras;
      const costEach=batchTotal/b;
      const addVAT=x=>vat?x*(1+VAT):x;
      const pList=[addVAT(costEach*(1+m1/100)), addVAT(costEach*(1+m2/100)), addVAT(costEach*(1+m3/100))];
      const unit=pList[tier-1], grand=unit*b;
      let compRow=''; const comp=n('competitor');
      if(comp){const cm=addVAT(comp)-costEach; const pct=(cm/costEach)*100;
        compRow=`<tr><td>Competitor (${addVAT(comp).toFixed(2)} ${cur()})</td>`+
                `<td class="${cm<0?'loss':'profit'}" style="text-align:right">${cm.toFixed(2)} ${cur()} (${pct.toFixed(0)}%)</td></tr>`;
      }
      result.innerHTML =
        `<div class="box"><b>Cost per batch</b><table>`+
        `<tr><td>Material</td><td style="text-align:right">${mat.toFixed(2)} ${cur()}</td></tr>`+
        `<tr><td>Electricity</td><td style="text-align:right">${ele.toFixed(2)} ${cur()}</td></tr>`+
        `<tr><td>Maintenance</td><td style="text-align:right">${mnt.toFixed(2)} ${cur()}</td></tr>`+
        `<tr><td>Handling</td><td style="text-align:right">${hb.toFixed(2)} ${cur()}</td></tr>`+
        `<tr><td>Extras</td><td style="text-align:right">${extras.toFixed(2)} ${cur()}</td></tr>`+
        `<tr><td><b class="break-even">Break-even / piece</b></td>`+
        `<td style="text-align:right"><b>${costEach.toFixed(2)} ${cur()}</b></td></tr>`+
        `</table></div>`+
        `<div class="box"><b>Unit prices (incl. margin)</b><table>`+
        `<tr><td>${m1}%</td><td style="text-align:right">${pList[0].toFixed(2)} ${cur()}</td></tr>`+
        `<tr><td>${m2}%</td><td style="text-align:right">${pList[1].toFixed(2)} ${cur()}</td></tr>`+
        `<tr><td>${m3}%</td><td style="text-align:right">${pList[2].toFixed(2)} ${cur()}</td></tr>`+
        `${compRow}</table></div>`+
        `<p><b>Quoted:</b> ${unit.toFixed(2)} ${cur()} × ${b} = ${grand.toFixed(2)} ${cur()}</p>`;
      currentCalc={name,unit,b,grand,vat,VAT};
    }

    function addToQuote(){
      if(!currentCalc){alert('Please calculate first!');return;} 
      const id='p'+Date.now();
      parts.push({id, name:currentCalc.name, quantity:currentCalc.b, unitPrice:currentCalc.unit, total:currentCalc.grand, vat:currentCalc.vat, VAT:currentCalc.VAT});
      renderPartsList(); updateTotalQuote();
      document.querySelector('.tab[data-tab="quote-list"]').click();
    }

    function renderPartsList(){
      const pl=document.getElementById('partsList'); pl.innerHTML='';
      if(parts.length===0){ pl.innerHTML='<p>No parts added yet.</p>'; return; }
      parts.forEach(p=>{
        const el=document.createElement('div'); el.className='part-item'; el.id=p.id;
        el.innerHTML=`<button class="remove-part" onclick="removePart('${p.id}')">×</button>`+
                     `<div class="part-header"><span class="part-name">${p.name}</span></div>`+
                     `<table>`+
                     `<tr><td>Qty</td><td style="text-align:right">${p.quantity}</td></tr>`+
                     `<tr><td>Unit Price</td><td style="text-align:right">${p.unitPrice.toFixed(2)} ${cur()}</td></tr>`+
                     `<tr><td>Total</td><td style="text-align:right">${p.total.toFixed(2)} ${cur()}</td></tr>`+
                     `</table>`;
        pl.appendChild(el);
      });
    }
    function removePart(id){ parts=parts.filter(p=>p.id!==id); renderPartsList(); updateTotalQuote(); }
    function clearParts(){ if(confirm('Clear all parts?')){ parts=[]; renderPartsList(); updateTotalQuote(); }}
    function updateTotalQuote(){ const s=n('shippingOrder'); const sub=parts.reduce((a,p)=>a+p.total,0); const tot=sub+s;
      document.getElementById('totalQuote').textContent=`Total Quote: ${tot.toFixed(2)} ${cur()}${s? ' (incl shipping)':''}`;
    }

    function printMultiPartQuote(){ if(parts.length===0){alert('Add parts first');return;} 
      const shipping=n('shippingOrder'), method=document.getElementById('shippingMethod').value;
      const sub=parts.reduce((a,p)=>a+p.total,0), tot=sub+shipping;
      const hasVAT=parts.some(p=>p.vat), VAT=hasVAT?parts[0].VAT:0;
      const cust=document.getElementById('customerInfo').value, pay=document.getElementById('paymentTerms').value, note=document.getElementById('additionalNotes').value;
      let rows=''; parts.forEach(p=>rows+=`<tr><td>${p.name}</td><td style="text-align:right">${p.quantity}</td><td style="text-align:right">${p.unitPrice.toFixed(2)} ${cur()}</td><td style="text-align:right">${p.total.toFixed(2)} ${cur()}</td></tr>`);
      const shipRow=shipping?`<tr><td>Shipping${method?' ('+method+')':''}</td><td></td><td></td><td style="text-align:right">${shipping.toFixed(2)} ${cur()}</td></tr>`:'';
      let notesHTML=''; if(cust||pay||note){notesHTML='<div style="margin-top:2em;border-top:1px solid #ccc;padding-top:1em">'; if(cust)notesHTML+=`<div><strong>Customer:</strong><br>${cust.replace(/\n/g,'<br>')}</div>`; if(pay)notesHTML+=`<div><strong>Payment Terms:</strong><br>${pay.replace(/\n/g,'<br>')}</div>`; if(note)notesHTML+=`<div><strong>Notes:</strong><br>${note.replace(/\n/g,'<br>')}</div>`; notesHTML+='</div>';}  
      const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Quote</title><style>@media print{*{-webkit-print-color-adjust:exact;print-color-adjust:exact}}@page{size:A4;margin:1.5cm}body{font:10pt sans-serif}h2{margin:0;font-size:14pt}table{width:100%;border-collapse:collapse}th,td{padding:4px 6px}th{background:#eee}tr:nth-child(even){background:#f9f9f9}}</style></head><body><h2>3D Print Quote</h2><small>Date: ${new Date().toLocaleDateString()}</small><table><tr><th>Description</th><th>Qty</th><th>Unit</th><th>Total</th></tr>${rows}${shipRow}<tr><td colspan="3" style="text-align:right;font-weight:bold">Grand Total</td><td style="text-align:right;font-weight:bold">${tot.toFixed(2)} ${cur()}</td></tr></table>${hasVAT?`<p>Includes VAT ${VAT*100}%</p>`:''}${notesHTML}<footer style="text-align:center;margin-top:1cm;font-size:9pt;color:#555">made with ❤️ by thefilip</footer></body></html>`;
      const w=window.open('','win','width=800,height=1100'); w.document.write(html); w.document.close(); setTimeout(()=>{w.focus();w.print();},300);
    }

    function generateShareableLink(){
      const ids=['itemName','currency','printerPreset','weight','batch','hours','filamentPrice','electricityPrice','power','maintenance','handling','vat','profit30','profit50','profit100','priceTier','competitor','postProcessPiece','packageBatch'];
      const ps=new URLSearchParams(); ids.forEach(id=>{ const el=document.getElementById(id); if(!el)return; const v=el.type==='checkbox'?el.checked:el.value; if(v!==''&&v!==false)ps.set(id,v);} );
      const url=location.origin+location.pathname+'?'+ps.toString(); const inp=document.getElementById('shareUrl'); inp.style.display='block'; inp.value=url; inp.select(); document.execCommand('copy'); alert('Link copied!');
    }

    document.getElementById('shippingOrder').addEventListener('input',updateTotalQuote);
  </script>
</body>
</html>
